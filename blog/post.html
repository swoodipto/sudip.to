<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Blog post">
    <title>Blog Post | My Personal Website</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Additional styles for blog content */
        .post-content img {
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="../blog.html" class="active">Blog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <article>
            <header class="post-header">
                <h1 id="post-title">Loading post...</h1>
                <div id="post-date" class="post-date"></div>
            </header>
            
            <div id="post-content" class="post-content">
                <!-- Post content will be loaded here -->
                <p>Loading post content...</p>
            </div>
            
            <a href="../blog.html" class="back-to-blog">‚Üê Back to all posts</a>
        </article>
    </main>

    <footer>
        <p>&copy; <span id="year"></span></p>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get the post slug from the URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            
            if (!slug) {
                document.getElementById('post-content').innerHTML = '<p>Post not found. Please specify a valid post slug.</p>';
                return;
            }
            
            loadPost(slug);
        });
        
        async function loadPost(slug) {
            const postTitle = document.getElementById('post-title');
            const postDate = document.getElementById('post-date');
            const postContent = document.getElementById('post-content');
            
            try {
                // Determine base URL for GitHub Pages
                const baseUrl = getBaseUrl();
                
                // First try to get post content from manifest
                const manifestResponse = await fetch(`${baseUrl}/posts/manifest.json`);
                if (!manifestResponse.ok) {
                    throw new Error('Failed to load posts manifest');
                }
                
                const manifest = await manifestResponse.json();
                let postData = null;
                
                // Check if manifest has posts array with metadata
                if (manifest.posts && Array.isArray(manifest.posts)) {
                    postData = manifest.posts.find(p => p.slug === slug);
                }
                
                // If not found in manifest posts array, try to load from markdown file
                if (!postData) {
                    // Check if the slug is in the files list
                    const filename = `${slug}.md`;
                    if (!manifest.files.includes(filename)) {
                        throw new Error('Post not found in manifest');
                    }
                    
                    // Try to load the markdown file
                    const postResponse = await fetch(`${baseUrl}/posts/${filename}`);
                    if (postResponse.ok) {
                        const markdown = await postResponse.text();
                        postData = extractPostData(markdown);
                        
                        if (!postData) {
                            throw new Error('Invalid post format');
                        }
                    } else {
                        // If markdown file can't be loaded, create a fallback
                        postData = {
                            title: slug.split('-').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1)
                            ).join(' '),
                            date: new Date().toISOString().split('T')[0],
                            content: `<p>Content for this post is not available.</p>
                                     <p>This could be because GitHub Pages doesn't serve raw markdown files directly.</p>
                                     <p>Please check the repository for the full content.</p>`
                        };
                    }
                }
                
                // Update title and metadata
                document.title = `${postData.title} | My Personal Website`;
                postTitle.textContent = postData.title;
                postDate.textContent = formatDate(postData.date);
                
                // Update meta description
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription && postData.excerpt) {
                    metaDescription.setAttribute('content', postData.excerpt);
                }
                
                // Display content
                if (postData.content) {
                    // If content is already HTML, use it directly
                    if (postData.content.includes('<')) {
                        postContent.innerHTML = postData.content;
                    } else {
                        // Otherwise convert markdown to HTML
                        postContent.innerHTML = convertMarkdownToHTML(postData.content);
                    }
                } else {
                    postContent.innerHTML = '<p>No content available for this post.</p>';
                }
            } catch (error) {
                console.error('Error loading post:', error);
                postContent.innerHTML = '<p>Failed to load post. Please try again later.</p>';
            }
        }
        
        // Get base URL based on current environment
        function getBaseUrl() {
            // Check if we're on GitHub Pages
            if (window.location.hostname.includes('github.io')) {
                // Extract repository name from path
                const pathParts = window.location.pathname.split('/');
                if (pathParts.length > 1 && pathParts[1]) {
                    return '/' + pathParts[1]; // e.g., '/sudip.to'
                }
            }
            return ''; // Local development
        }
        
        // Extract post data from markdown content
        function extractPostData(markdown) {
            const frontMatterMatch = markdown.match(/^---\s*([\s\S]*?)\s*---/);
            if (!frontMatterMatch) return null;
            
            const frontMatter = frontMatterMatch[1];
            const content = markdown.replace(/^---\s*[\s\S]*?---/, '').trim();
            
            // Parse front matter
            const titleMatch = frontMatter.match(/title:\s*(.*)/);
            const dateMatch = frontMatter.match(/date:\s*(.*)/);
            const excerptMatch = frontMatter.match(/excerpt:\s*(.*)/);
            
            if (!titleMatch || !dateMatch) return null;
            
            return {
                title: titleMatch[1].trim(),
                date: dateMatch[1].trim(),
                excerpt: excerptMatch ? excerptMatch[1].trim() : '',
                content: content
            };
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Simple markdown to HTML converter
        function convertMarkdownToHTML(markdown) {
            let html = markdown;
            
            // Headers
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            
            // Bold and italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Images - Add this before links
            html = html.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">');
            
            // Links
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
            
            // Lists
            html = html.replace(/^\s*\*\s(.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Ordered lists
            html = html.replace(/^\s*\d+\.\s(.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Blockquotes
            html = html.replace(/^>\s(.*$)/gm, '<blockquote>$1</blockquote>');
            
            // Paragraphs (must be last)
            html = html.replace(/^(?!<[a-z])(.*$)/gm, '<p>$1</p>');
            
            return html;
        }
    </script>
</body>
</html> 